<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Linux åº”æ€¥å“åº”æŠ¥å‘ŠæŸ¥çœ‹å™¨</title>
<style>
body { 
  font-family: "Microsoft YaHei", Arial, sans-serif; 
  background: #f5f5f5; 
  margin: 0;
  padding: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.header {
  background: #fff;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  position: sticky;
  top: 0;
  z-index: 1000;
}

.header h1 {
  margin: 0 0 15px 0;
}

.main-container {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.content-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.sidebar {
  width: 300px;
  background: #fff;
  border-left: 1px solid #e0e0e0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-header {
  padding: 15px;
  background: #f8f9fa;
  border-bottom: 1px solid #e0e0e0;
}

.alert-container {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
}

.alert { 
  padding: 15px; 
  margin-bottom: 10px; 
  border-radius: 5px;
}

.alert-high { 
  background: #ffebee; 
  color: #c62828; 
  border-left: 5px solid #c62828; 
}

.alert-medium { 
  background: #fff3e0; 
  color: #ef6c00; 
  border-left: 5px solid #ef6c00; 
}

.alert-low { 
  background: #e3f2fd; 
  color: #1565c0; 
  border-left: 5px solid #1565c0; 
}

.alert-link { 
  cursor: pointer; 
  color: inherit; 
  text-decoration: underline; 
}

.alert-count { 
  background: #fff; 
  padding: 2px 8px; 
  border-radius: 10px; 
  margin-left: 10px; 
  font-size: 12px; 
}

.search-container {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px 0;
}

#searchInput {
  flex: 1;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 3px;
  min-width: 200px;
}

.search-nav {
  display: flex;
  align-items: center;
  gap: 10px;
  white-space: nowrap;
}

.search-nav button {
  padding: 8px 15px;
  background: #2196F3;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
}

.search-nav button:hover {
  background: #1976D2;
}

.search-nav button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.tabs {
  overflow: hidden;
  background: #333;
  border-radius: 5px;
  margin-bottom: 10px;
}

.tabs button {
  background: #333;
  color: #fff;
  float: left;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
  font-size: 16px;
}

.tabs button:hover {
  background: #ddd;
  color: black;
}

.tabs button.active {
  background: #2196F3;
  color: white;
}

.tabcontent {
  display: none;
  padding: 20px;
  background: #fff;
  border-radius: 5px;
  margin-top: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.tabcontent pre {
  background: #222;
  color: #eee;
  padding: 15px;
  border-radius: 5px;
  overflow-x: auto;
  margin: 0;
  font-size: 14px;
  white-space: pre-wrap; /* å…è®¸è‡ªåŠ¨æ¢è¡Œ */
  word-wrap: break-word; /* åœ¨é•¿å•è¯æˆ–URLåœ°å€å†…éƒ¨è¿›è¡Œæ¢è¡Œ */
}

.tabcontent details {
  margin-bottom: 10px;
}

.tabcontent summary {
  cursor: pointer;
  font-weight: bold;
  padding: 10px;
  background: #f0f0f0;
  border-radius: 3px;
}

.mark {
  background: yellow;
  color: red;
  font-weight: bold;
}

.mark.current {
  background: #ff4444;
  color: white;
}

#fileInput {
  margin: 10px 0;
}

.alert-summary {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.alert-badge {
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.alert-badge.high {
  background: #ffebee;
  color: #c62828;
}

.alert-badge.medium {
  background: #fff3e0;
  color: #ef6c00;
}

.alert-badge.low {
  background: #e3f2fd;
  color: #1565c0;
}

.alert-badge .count {
  font-weight: bold;
}

.collapse-button {
  padding: 5px 10px;
  background: none;
  border: 1px solid #ccc;
  border-radius: 3px;
  cursor: pointer;
  margin-left: auto;
}

.collapse-button:hover {
  background: #f0f0f0;
}

@keyframes highlight-pulse {
  0% { background: #ff4444; }
  50% { background: #ff8888; }
  100% { background: #ff4444; }
}
.alert-check {
  background: #fff9c4;
  color: #827717;
  border-left: 5px solid #d4af37;
}

.alert-check pre {
  background: #fffde7;
  padding: 10px;
  font-size: 14px;
}
</style>
<script>
const TAB_TITLES = {
  backdoor: "ç³»ç»Ÿåé—¨æ’æŸ¥",
  user: "ç”¨æˆ·ä¸ç™»å½•æ£€æŸ¥",
  log: "æ—¥å¿—åˆ†æ",
  network: "ç½‘ç»œæ£€æŸ¥",
  process: "è¿›ç¨‹æ£€æŸ¥",
  filesystem: "æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥",
  package: "è½¯ä»¶åŒ…æ£€æŸ¥",
  persistence: "æŒä¹…åŒ–æ£€æŸ¥",
  integrity: "ç³»ç»Ÿå®Œæ•´æ€§",
  malware: "æ¶æ„è¿›ç¨‹ä¸ææƒç‚¹",
  // summary: "åŠŸèƒ½æ€»ç»“ä¸ä½¿ç”¨è¯´æ˜"
};

const SUB_TAB_TITLES = {
  backdoor: ["UIDä¸º0çš„érootç”¨æˆ·", "å¯ç–‘ç³»ç»Ÿé…ç½®", "å¼‚å¸¸ç³»ç»Ÿæ–‡ä»¶"],
  user: ["å½“å‰ç”¨æˆ·", "æ‰€æœ‰ç”¨æˆ·", "æœ€è¿‘ç™»å½•è®°å½•", "ç™»å½•å¤±è´¥è®°å½•"],
  log: ["ç³»ç»Ÿæ—¥å¿—é”™è¯¯", "å®‰å…¨æ—¥å¿—é”™è¯¯"],
  network: ["ç›‘å¬ç«¯å£", "æ´»åŠ¨è¿æ¥", "ç½‘ç»œé…ç½®", "è·¯ç”±è¡¨", "å¯ç–‘è¿æ¥"],
  process: ["é«˜CPUå ç”¨è¿›ç¨‹", "å¯ç–‘è„šæœ¬è¿›ç¨‹"],
  filesystem: ["SUIDæ–‡ä»¶", "æœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶"],
  package: ["å·²å®‰è£…çš„è½¯ä»¶åŒ…"],
  persistence: ["è‡ªå¯åŠ¨æœåŠ¡", "è®¡åˆ’ä»»åŠ¡", "SSHå…¬é’¥", "å¯åŠ¨é¡¹é…ç½®"],
  integrity: ["å…³é”®äºŒè¿›åˆ¶æ–‡ä»¶æ ¡éªŒ", "ç³»ç»Ÿæ–‡ä»¶å®Œæ•´æ€§"],
  malware: ["å¯ç–‘è¿›ç¨‹", "å¯ç–‘ææƒç‚¹", "éšè—æ–‡ä»¶"],
  // summary: ["åŠŸèƒ½è¯´æ˜"]
};

let gTabs = Object.keys(TAB_TITLES);
let gContent = "";
let currentSearchIndex = -1;
let searchResults = [];

// å‘Šè­¦ç»“æœå­˜å‚¨
let alertResults = {
  high: [],
  medium: [],
  low: []
};

function parseTextReport(text) {
  const sections = text.split("##########################################");
  const data = {};
  let currentSection = null;

  for (const section of sections) {
    if (!section.trim()) continue;

    const moduleMatch = section.match(/æ¨¡å—: (.*?)\n/);
    if (!moduleMatch) continue;

    const moduleTitle = moduleMatch[1];
    const moduleKey = Object.keys(TAB_TITLES).find(key => TAB_TITLES[key] === moduleTitle);
    if (!moduleKey) continue;

    const subSections = section.split("------------------------------------------");
    data[moduleKey] = {};

    for (let i = 1; i < subSections.length; i += 2) {
      const titleMatch = subSections[i].match(/å­é¡¹: (.*?)\n/);
      if (!titleMatch) continue;
      const title = titleMatch[1];
      const content = subSections[i + 1] ? subSections[i + 1].trim() : "";
      data[moduleKey][title] = content;
    }
  }

  return data;
}

function openTab(evt, tabName) {
  const tabcontent = document.getElementsByClassName("tabcontent");
  for (let i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  const tablinks = document.getElementsByClassName("tablinks");
  for (let i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.className += " active";
}

function findAllMatches(text, searchTerm) {
  if (!searchTerm) return [];
  const regex = new RegExp(searchTerm, 'gi');
  const matches = [];
  let match;
  while ((match = regex.exec(text)) !== null) {
    matches.push({
      index: match.index,
      text: match[0],
      position: matches.length,
      end: match.index + match[0].length
    });
  }
  return matches;
}

function searchTabs() {
  const input = document.getElementById("searchInput").value.toLowerCase();
  if (!input) {
    updateSearchCount(0, -1);
    return;
  }

  searchResults = [];
  currentSearchIndex = -1;

  const tabs = document.getElementsByClassName("tabcontent");
  for (let i = 0; i < tabs.length; i++) {
    const tabId = tabs[i].id;
    const pres = tabs[i].getElementsByTagName("pre");
    for (let j = 0; j < pres.length; j++) {
      const preText = pres[j].textContent;
      const matches = findAllMatches(preText, input);
      matches.forEach(match => {
        searchResults.push({
          tabId,
          preIndex: j,
          ...match
        });
      });
    }
  }

  highlightCurrentMatch();
  updateSearchCount(searchResults.length, currentSearchIndex);
}

function updateSearchCount(total, current) {
  const countElement = document.getElementById("searchCount");
  if (total === 0) {
    countElement.textContent = "æœªæ‰¾åˆ°åŒ¹é…é¡¹";
    document.getElementById("prevMatch").disabled = true;
    document.getElementById("nextMatch").disabled = true;
  } else {
    countElement.textContent = `${current + 1}/${total}`;
    document.getElementById("prevMatch").disabled = current <= 0;
    document.getElementById("nextMatch").disabled = current >= total - 1;
  }
}

function navigateSearch(direction) {
  if (searchResults.length === 0) return;

  currentSearchIndex += direction;
  if (currentSearchIndex < 0) currentSearchIndex = searchResults.length - 1;
  if (currentSearchIndex >= searchResults.length) currentSearchIndex = 0;

  highlightCurrentMatch();
  updateSearchCount(searchResults.length, currentSearchIndex);
}

function highlightCurrentMatch() {
  // æ¸…é™¤æ‰€æœ‰é«˜äº®
  const tabs = document.getElementsByClassName("tabcontent");
  for (let i = 0; i < tabs.length; i++) {
    const pres = tabs[i].getElementsByTagName("pre");
    for (let j = 0; j < pres.length; j++) {
      let html = pres[j].innerHTML.replace(/<span class="mark.*?">(.*?)<\/span>/g, "$1");
      pres[j].innerHTML = html;
    }
  }

  if (searchResults.length === 0 || currentSearchIndex === -1) return;

  const currentMatch = searchResults[currentSearchIndex];

  // åˆ‡æ¢åˆ°å¯¹åº”çš„æ ‡ç­¾é¡µ
  const tabButton = document.querySelector(`button[onclick="openTab(event, '${currentMatch.tabId}')"]`);
  if (tabButton) {
    tabButton.click();
  }

  // é«˜äº®æ‰€æœ‰åŒ¹é…é¡¹ï¼Œå½“å‰åŒ¹é…é¡¹ç‰¹æ®Šé«˜äº®
  const searchTerm = document.getElementById("searchInput").value;
  const regex = new RegExp(`(${searchTerm})`, 'gi');
  const targetPre = document.getElementById(currentMatch.tabId)
    .getElementsByTagName("pre")[currentMatch.preIndex];

  targetPre.innerHTML = targetPre.textContent.replace(regex, (match, p1, offset) => {
    const isCurrentMatch = offset === currentMatch.index;
    return `<span class="mark${isCurrentMatch ? ' current' : ''}">${match}</span>`;
  });

  // æ‰¾åˆ°å½“å‰åŒ¹é…é¡¹çš„å…ƒç´ 
  const currentElement = targetPre.querySelector('.mark.current');
  if (currentElement) {
    // è·å–çˆ¶çº§detailså…ƒç´ 
    const detailsElement = targetPre.closest('details');
    if (detailsElement && !detailsElement.open) {
      detailsElement.open = true;
    }

    // è®¡ç®—æ»šåŠ¨ä½ç½®
    const contentContainer = document.querySelector('.content-container');
    const elementRect = currentElement.getBoundingClientRect();
    const containerRect = contentContainer.getBoundingClientRect();

    // æ£€æŸ¥å…ƒç´ æ˜¯å¦åœ¨è§†å›¾ä¸­
    const isInView = (
      elementRect.top >= containerRect.top &&
      elementRect.bottom <= containerRect.bottom
    );

    if (!isInView) {
      // è®¡ç®—ç†æƒ³çš„æ»šåŠ¨ä½ç½®ï¼ˆå°†åŒ¹é…é¡¹æ”¾åœ¨å®¹å™¨ä¸­é—´ï¼‰
      const elementTop = elementRect.top + contentContainer.scrollTop - containerRect.top;
      const containerMiddle = containerRect.height / 2;
      const scrollTo = elementTop - containerMiddle + elementRect.height / 2;

      // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
      contentContainer.scrollTo({
        top: scrollTo,
        behavior: 'smooth'
      });
    }

    // æ·»åŠ é—ªçƒåŠ¨ç”»ä»¥çªå‡ºæ˜¾ç¤ºå½“å‰åŒ¹é…é¡¹
    currentElement.style.animation = 'none';
    currentElement.offsetHeight; // è§¦å‘é‡ç»˜
    currentElement.style.animation = 'highlight-pulse 1s';
  }
}

// æ·»åŠ è§„åˆ™å¼•æ“APIè°ƒç”¨
async function analyzeReport(data) {
  try {
    const response = await fetch('http://localhost:35000/analyze', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const results = await response.json();
    alertResults = results;
    displayAlerts();
  } catch (error) {
    console.error('è§„åˆ™åˆ†æå¤±è´¥:', error);
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    const container = document.getElementById('alertContainer');
    container.innerHTML = `
      <div class="alert alert-high">
        <div>
          <strong>è§„åˆ™åˆ†æå¤±è´¥</strong>
          <p>æ— æ³•è¿æ¥åˆ°è§„åˆ™å¼•æ“æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œã€‚</p>
          <p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
        </div>
      </div>
    `;
  }
}

// ä¿®æ”¹renderTabså‡½æ•°
function renderTabs(data) {
  const tabBtnHtml = gTabs.map((k, i) =>
    `<button class="tablinks" onclick="openTab(event, '${k}')">${TAB_TITLES[k]}</button>`
  ).join("");
  document.getElementById("tabBtns").innerHTML = tabBtnHtml;

  const tabContentHtml = gTabs.map(k => {
    const subTitles = SUB_TAB_TITLES[k];
    const subContent = subTitles.map(title => {
      const content = data[k] && data[k][title] ? data[k][title] : "";
      return `<details open><summary>${title}</summary><pre>${escapeHtml(content)}</pre></details>`;
    }).join("");
    return `<div id="${k}" class="tabcontent">${subContent}</div>`;
  }).join("");
  document.getElementById("tabContents").innerHTML = tabContentHtml;

  if (gTabs.length) {
    setTimeout(() => document.getElementsByClassName("tablinks")[0].click(), 100);
  }

  // è°ƒç”¨è§„åˆ™å¼•æ“APIè¿›è¡Œåˆ†æ
  analyzeReport(data);
}

function escapeHtml(str) {
  if (!str) return "";
  return str.replace(/[&<>]/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[c]));
}

document.addEventListener("DOMContentLoaded", function () {
  const select = document.getElementById('reportSelect');

  fetch('/list_reports')
    .then(response => {
      if (!response.ok) throw new Error('HTTPè¯·æ±‚å¤±è´¥');
      return response.json();
    })
    .then(data => {
      console.log('âœ… æ¥æ”¶åˆ°æŠ¥å‘Šåˆ—è¡¨:', data);

      select.innerHTML = ''; // æ¸…ç©ºæ—§å†…å®¹

      if (data.files && data.files.length > 0) {
        data.files.forEach(file => {
          if (file.endsWith('.txt')) {
            const option = document.createElement('option');
            option.value = file;
            option.textContent = file;
            select.appendChild(option);
            console.log('ğŸ“Œ æ·»åŠ é€‰é¡¹:', file);
          }
        });
      }
    })
    .catch(error => {
      console.error('âŒ è·å–æŠ¥å‘Šåˆ—è¡¨å¤±è´¥:', error);
      select.innerHTML = '';
    });
});


// æ·»åŠ ä¾§è¾¹æ æŠ˜å åŠŸèƒ½
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const button = document.querySelector('.collapse-button');
  if (sidebar.style.width === '0px') {
    sidebar.style.width = '300px';
    button.textContent = 'æ”¶èµ·å‘Šè­¦é¢æ¿ >';
  } else {
    sidebar.style.width = '0px';
    button.textContent = '< å±•å¼€å‘Šè­¦é¢æ¿';
  }
}

// æ·»åŠ æ˜¾ç¤ºå‘Šè­¦çš„å‡½æ•°
function displayAlerts() {
  const container = document.getElementById('alertContainer');
  const summary = document.getElementById('alertSummary');

  // æ¸…ç©ºç°æœ‰å†…å®¹
  container.innerHTML = '';
  summary.innerHTML = '';

  // æ˜¾ç¤ºå‘Šè­¦ç»Ÿè®¡
  const summaryHtml = `
    <div class="alert-badge high">
      <span>é«˜å±å‘Šè­¦</span>
      <span class="count">${alertResults.high.length}</span>
    </div>
    <div class="alert-badge medium">
      <span>ä¸­å±å‘Šè­¦</span>
      <span class="count">${alertResults.medium.length}</span>
    </div>
    <div class="alert-badge low">
      <span>ä½å±å‘Šè­¦</span>
      <span class="count">${alertResults.low.length}</span>
    </div>
  `;
  summary.innerHTML = summaryHtml;

  // æ˜¾ç¤ºå‘Šè­¦è¯¦æƒ…
  const alertsHtml = [
    ...alertResults.high.map(alert => `
      <div class="alert alert-high">
        <div>
          <strong>${alert.description}</strong>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            è§„åˆ™ID: ${alert.rule_id} | æ¨¡å—: ${alert.section} | å­é¡¹: ${alert.subsection}
          </div>
          ${alert.findings ? `
            <div style="margin-top: 10px;">
              <strong>å‘ç°:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${alert.findings.map(finding => `
                  <li style="cursor: pointer;" onclick="scrollToPosition('${alert.section}', '${alert.subsection}', ${finding.start}, ${finding.end})">
                    ä½ç½®: ${finding.start}-${finding.end}, åŒ¹é…æ–‡æœ¬: "${finding.matched_text}"
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      </div>
    `),
    ...alertResults.medium.map(alert => `
      <div class="alert alert-medium">
        <div>
          <strong>${alert.description}</strong>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            è§„åˆ™ID: ${alert.rule_id} | æ¨¡å—: ${alert.section} | å­é¡¹: ${alert.subsection}
          </div>
          ${alert.findings ? `
            <div style="margin-top: 10px;">
              <strong>å‘ç°:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${alert.findings.map(finding => `
                  <li style="cursor: pointer;" onclick="scrollToPosition('${alert.section}', '${alert.subsection}', ${finding.start}, ${finding.end})">
                    ä½ç½®: ${finding.start}-${finding.end}, åŒ¹é…æ–‡æœ¬: "${finding.matched_text}"
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      </div>
    `),
    ...alertResults.low.map(alert => `
      <div class="alert alert-low">
        <div>
          <strong>${alert.description}</strong>
          <div style="margin-top: 5px; font-size: 12px; color: #666;">
            è§„åˆ™ID: ${alert.rule_id} | æ¨¡å—: ${alert.section} | å­é¡¹: ${alert.subsection}
          </div>
          ${alert.findings ? `
            <div style="margin-top: 10px;">
              <strong>å‘ç°:</strong>
              <ul style="margin: 5px 0; padding-left: 20px;">
                ${alert.findings.map(finding => `
                  <li style="cursor: pointer;" onclick="scrollToPosition('${alert.section}', '${alert.subsection}', ${finding.start}, ${finding.end})">
                    ä½ç½®: ${finding.start}-${finding.end}, åŒ¹é…æ–‡æœ¬: "${finding.matched_text}"
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      </div>
    `)
  ].join('');

  container.innerHTML = alertsHtml;
}

// æ·»åŠ åˆ†ææŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†å‡½æ•°
function analyzeCurrentData() {
  const fileInput = document.getElementById('fileInput');
  if (!fileInput.files.length) {
    alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const text = e.target.result;
      let data;
      try {
        data = JSON.parse(text);
      } catch (jsonError) {
        data = parseTextReport(text);
      }
      // å…ˆæ¸²æŸ“æ ‡ç­¾é¡µ
      renderTabs(data);
      // ç„¶ååˆ†ææŠ¥å‘Š
      analyzeReport(data);
    } catch (err) {
      alert("åˆ†æå¤±è´¥ï¼š" + err.message);
    }
  };
  reader.readAsText(file);
}

// æ·»åŠ è·³è½¬åˆ°æŒ‡å®šä½ç½®çš„å‡½æ•°
function scrollToPosition(section, subsection, start, end) {
  // åˆ‡æ¢åˆ°å¯¹åº”çš„æ ‡ç­¾é¡µ
  const tabButton = document.querySelector(`button[onclick="openTab(event, '${section}')"]`);
  if (tabButton) {
    tabButton.click();
  }

  // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿tabå†…å®¹å·²æ¸²æŸ“
  setTimeout(() => {
    const details = document.querySelectorAll(`#${section} details`);
    let totalOffset = 0; // ç”¨äºè·Ÿè¸ªåœ¨æ‰€æœ‰preæ ‡ç­¾ä¸­çš„ç´¯ç§¯åç§»é‡

    for (const detail of details) {
      const summary = detail.querySelector('summary');
      if (!summary) continue;

      const pre = detail.querySelector('pre');
      if (!pre) continue;

      const text = pre.textContent;
      const textLength = text.length;

      // æ£€æŸ¥ç›®æ ‡ä½ç½®æ˜¯å¦åœ¨å½“å‰preæ ‡ç­¾çš„èŒƒå›´å†…
      if (start >= totalOffset && start < totalOffset + textLength) {
        detail.open = true;

        // è®¡ç®—ç›¸å¯¹äºå½“å‰preçš„ä½ç½®
        const relativeStart = start - totalOffset;
        const relativeEnd = Math.min(end - totalOffset, textLength);

        // è·å–ç›®æ ‡æ–‡æœ¬
        const targetText = text.substring(relativeStart, relativeEnd);

        // æ¸…é™¤æ‰€æœ‰ç°æœ‰é«˜äº®
        pre.innerHTML = escapeHtml(text);

        // é‡æ–°è®¡ç®—ä½ç½®å¹¶é«˜äº®
        const beforeText = text.substring(0, relativeStart);
        const afterText = text.substring(relativeEnd);

        pre.innerHTML = escapeHtml(beforeText) +
          `<span class="mark current" style="animation: highlight-pulse 1s;">${escapeHtml(targetText)}</span>` +
          escapeHtml(afterText);

        // æ»šåŠ¨åˆ°é«˜äº®ä½ç½®
        const contentContainer = document.querySelector('.content-container');
        const highlightedElement = pre.querySelector('.mark.current');

        if (highlightedElement) {
          const preRect = pre.getBoundingClientRect();
          const elementRect = highlightedElement.getBoundingClientRect();
          const containerRect = contentContainer.getBoundingClientRect();

          // è®¡ç®—æ»šåŠ¨ä½ç½®ï¼šå°†é«˜äº®å…ƒç´ å±…ä¸­æ˜¾ç¤º
          const scrollTo = (elementRect.top + contentContainer.scrollTop) -
                         (containerRect.height / 2) +
                         (elementRect.height / 2);

          contentContainer.scrollTo({
            top: scrollTo,
            behavior: 'smooth'
          });
        }

        break;
      }

      totalOffset += textLength;
    }
  }, 100);
}

// æ·»åŠ ä¸€ä¸ªç”¨äºè°ƒè¯•çš„å‡½æ•°ï¼Œå¸®åŠ©å®šä½é—®é¢˜
function debugPosition(section, subsection, start, end) {
  const details = document.querySelectorAll(`#${section} details`);
  let totalOffset = 0;

  for (const detail of details) {
    const summary = detail.querySelector('summary');
    if (!summary) continue;

    const pre = detail.querySelector('pre');
    if (!pre) continue;

    const text = pre.textContent;
    console.log(`Section: ${section}`);
    console.log(`Subsection: ${summary.textContent}`);
    console.log(`Text length: ${text.length}`);
    console.log(`Current total offset: ${totalOffset}`);
    console.log(`Target start-end: ${start}-${end}`);
    console.log(`Text preview: ${text.substring(Math.max(0, start - totalOffset - 10), Math.min(text.length, end - totalOffset + 10))}`);
    console.log('---');

    totalOffset += text.length;
  }
}

// ç‚¹å‡»â€œæœ¬åœ°åˆ†æâ€æŒ‰é’®ï¼Œå‘é€é€‰å®šçš„æ–‡ä»¶ååˆ° /analyze_file
function analyzeSelectedFile() {
  const selectedFile = document.getElementById('reportSelect').value;
  if (!selectedFile) {
    alert("è¯·é€‰æ‹©ä¸€ä¸ªæŠ¥å‘Šæ–‡ä»¶");
    return;
  }

  // ç›´æ¥è·å–å¹¶è§£æåŸå§‹æŠ¥å‘Šæ–‡ä»¶
  fetch(`http://localhost:35000/report/${encodeURIComponent(selectedFile)}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.text();
    })
    .then(rawText => {
      // è§£æåŸå§‹æ–‡æœ¬æŠ¥å‘Š
      const parsedData = parseTextReport(rawText);

      // ç¡®ä¿æ‰€æœ‰å­é¡¹éƒ½æœ‰å€¼ï¼ˆé¿å…undefinedï¼‰
      const safeData = {};
      Object.keys(parsedData).forEach(moduleKey => {
        safeData[moduleKey] = {...parsedData[moduleKey]};

        const subTitles = SUB_TAB_TITLES[moduleKey] || [];
        subTitles.forEach(subTitle => {
          if (!(subTitle in safeData[moduleKey])) {
            safeData[moduleKey][subTitle] = "";
          }
        });
      });

      // æ¸²æŸ“æ ‡ç­¾é¡µ
      renderTabs(safeData);

      // åŒæ—¶å‘é€åˆ°è§„åˆ™å¼•æ“è¿›è¡Œåˆ†æ
      fetch('http://localhost:35000/analyze', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(safeData)
      })
      .then(res => {
        if (!res.ok) throw new Error('åˆ†æå¤±è´¥');
        return res.json();
      })
      .then(results => {
        alertResults = results;
        displayAlerts();
      })
      .catch(error => {
        console.error('è§„åˆ™åˆ†æå¤±è´¥:', error);
        // å¦‚æœåˆ†æå¤±è´¥ï¼Œè‡³å°‘æ˜¾ç¤ºåŸºæœ¬å‘Šè­¦é¢æ¿
        displayAlerts();
      });
    })
    .catch(error => {
      console.error('æ–‡ä»¶åŠ è½½å¤±è´¥:', error);
      alert("æ–‡ä»¶åŠ è½½å¤±è´¥ï¼š" + error.message);
    });
}


// æ˜¾ç¤ºä»æ¥å£è¿”å›çš„å‘Šè­¦ä¿¡æ¯
function displayAlertsFromAPI(results) {
  const container = document.getElementById('alertContainer');
  const summary = document.getElementById('alertSummary');
  container.innerHTML = '';
  summary.innerHTML = '';

  // å¤„ç†æ‰€æœ‰çº§åˆ«çš„å‘Šè­¦
  const allAlerts = [];
  ['high', 'medium', 'low'].forEach(level => {
    if (results[level] && results[level].length > 0) {
      results[level].forEach(alert => {
        allAlerts.push({...alert, level});
      });
    }
  });

  // å¦‚æœæ²¡æœ‰å‘Šè­¦
  if (allAlerts.length === 0) {
    container.innerHTML = '<div class="alert alert-low">æœªå‘ç°å®‰å…¨å‘Šè­¦</div>';
    return;
  }

  // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
  const summaryHtml = `    <div class="alert-badge high">
      <span>é«˜å±å‘Šè­¦</span>
      <span class="count">${results.high ? results.high.length : 0}</span>
    </div>
    <div class="alert-badge medium">
      <span>ä¸­å±å‘Šè­¦</span>
      <span class="count">${results.medium ? results.medium.length : 0}</span>
    </div>
    <div class="alert-badge low">
      <span>ä½å±å‘Šè­¦</span>
      <span class="count">${results.low ? results.low.length : 0}</span>
    </div>
  `;
  summary.innerHTML = summaryHtml;

  // æ˜¾ç¤ºè¯¦ç»†å‘Šè­¦ä¿¡æ¯
  const alertsHtml = allAlerts.map(alert => {
    let className = 'alert-low';
    if (alert.level === 'high') className = 'alert-high';
    if (alert.level === 'medium') className = 'alert-medium';

    return `      <div class="alert ${className}">
        <strong>${alert.description || 'æœªçŸ¥å‘Šè­¦'}</strong><br>
        è§„åˆ™ID: ${alert.rule_id || 'N/A'} |
        æ¨¡å—: ${alert.section || 'N/A'} |
        å­é¡¹: ${alert.subsection || 'N/A'}      </div>
    `;
  }).join('');

  container.innerHTML = alertsHtml;
}

function ensureAllSubsections(data) {
  const result = {...data};
  Object.keys(TAB_TITLES).forEach(moduleKey => {
    if (!result[moduleKey]) {
      result[moduleKey] = {};
    }

    const subTitles = SUB_TAB_TITLES[moduleKey] || [];
    subTitles.forEach(subTitle => {
      if (!result[moduleKey][subTitle]) {
        result[moduleKey][subTitle] = "";
      }
    });
  });
  return result;
}
function runServerCheck() {
  const resultDiv = document.getElementById("alertContainer");
  resultDiv.innerHTML = '<div class="alert alert-low">æ­£åœ¨è¿è¡ŒæœåŠ¡å™¨æ£€æŸ¥ï¼Œè¯·ç¨å€™...</div>';

  fetch('/check', {
    method: 'GET'
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(data => {
        throw new Error(data.error || 'æœªçŸ¥é”™è¯¯');
      });
    }
    return response.json();
  })
  .then(data => {
    let output = '';

    if (typeof data.stdout === 'string') {
      try {
        output = decodeURIComponent(JSON.parse(`"${data.stdout}"`));
      } catch (e) {
        output = data.stdout;
      }
    }

    resultDiv.innerHTML = `
      <div class="alert alert-medium">
        <strong>æœåŠ¡å™¨æ£€æŸ¥æˆåŠŸï¼</strong><br>
        è¾“å‡ºä¿¡æ¯ï¼š<pre>${output}</pre>
      </div>
    `;

    // âœ… æ£€æŸ¥å®Œæˆä¹‹ååˆ·æ–°æŠ¥å‘Šåˆ—è¡¨
    refreshReportList();

  })
  .catch(error => {
    resultDiv.innerHTML = `
      <div class="alert alert-high">
        <strong>æœåŠ¡å™¨æ£€æŸ¥å¤±è´¥ï¼š</strong><br>
        ${error.message}
      </div>
    `;
    // å³ä½¿å¤±è´¥ä¹Ÿå°è¯•åˆ·æ–°åˆ—è¡¨
    refreshReportList();
  });
}

//åˆ·æ–°åˆ—è¡¨
function refreshReportList() {
  const select = document.getElementById('reportSelect');
  select.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹

  fetch('/list_reports')
    .then(response => {
      if (!response.ok) {
        throw new Error('HTTPè¯·æ±‚å¤±è´¥');
      }
      return response.json();
    })
    .then(data => {
      if (data.files && data.files.length > 0) {
        data.files.forEach(file => {
          if (file.endsWith('.txt')) {
            const option = document.createElement('option');
            option.value = file;
            option.textContent = file;
            select.appendChild(option);
          }
        });
      } else {
        // å¯é€‰ï¼šæ·»åŠ ä¸€ä¸ªæç¤ºé¡¹
        const option = document.createElement('option');
        option.disabled = true;
        option.textContent = 'æš‚æ— å¯ç”¨æŠ¥å‘Š';
        select.appendChild(option);
      }
    })
    .catch(error => {
      console.error('è·å–æŠ¥å‘Šåˆ—è¡¨å¤±è´¥:', error);
      // å¯é€‰ï¼šæ˜¾ç¤ºé”™è¯¯æˆ–é‡ç½®ä¸‹æ‹‰æ¡†
      select.innerHTML = '';
    });
}


</script>
</head>
<body>
<div class="header">
  <h1>æœåŠ¡å™¨åº”æ€¥æ£€æµ‹å·¥å…·</h1>
  <div style="display: flex; gap: 10px; align-items: center;">
    <input type="file" id="fileInput" accept=".txt,.json">
    <button onclick="analyzeCurrentData()" style="padding: 8px 15px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer;">åˆ†ææŠ¥å‘Š</button>
  </div>
  <div style="display: flex; gap: 10px; align-items: center;">
    <label for="reportSelect">é€‰æ‹©æŠ¥å‘Š:</label>
    <select id="reportSelect" style="padding: 8px;"></select>
    <button onclick="analyzeSelectedFile()" style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">æœ¬åœ°åˆ†æ</button>
    <button id="runCheckButton" onclick="runServerCheck()" style="padding: 8px 15px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">è¿è¡ŒæœåŠ¡å™¨æ£€æŸ¥</button>
  </div>
  <div class="search-container">
    <input type="text" id="searchInput" onkeyup="searchTabs()" placeholder="è¾“å…¥å…³é”®è¯é«˜äº®...">
    <div class="search-nav">
      <button id="prevMatch" disabled>ä¸Šä¸€ä¸ª</button>
      <span id="searchCount" class="search-count">0/0</span>
      <button id="nextMatch" disabled>ä¸‹ä¸€ä¸ª</button>
    </div>
    <button class="collapse-button" onclick="toggleSidebar()">æ”¶èµ·å‘Šè­¦é¢æ¿ ></button>
  </div>
  <div id="alertSummary" class="alert-summary"></div>
</div>

<div class="main-container">
  <div class="content-container">
    <div class="tabs" id="tabBtns"></div>
    <div id="tabContents"></div>
  </div>
  <div class="sidebar">
    <div class="sidebar-header">
      <h3 style="margin: 0;">å‘Šè­¦ä¿¡æ¯</h3>
    </div>
    <div id="alertContainer" class="alert-container"></div>
  </div>
</div>
</body>
</html>

